Headphones - Progress
---------------------
Have 4 pre-amps, and 1 MOhm/10kOhm does give 100x gain.
Ambient sounds are still pretty low. Humming nearby
gives maybe 1V p-p, so 0.5V amplitude, or 1/10 of 1023 for 0-5V
or 100 integer precision, and we're ignoring the lower 2 bits,
so that's 128/4 = 32 integers for the entire sinusoid. Not a lot! 

Still, proceed. 

Added 0.1uF bypass caps to pre-amp setup,
didn't check capacitive loading allowance on datasheet, but saw 
what it looked like connected to a running ADC using
the logic analyzer. 

Forgot to downsample to "changes" so got a 1 GB file sampling at 6.5 MHz for 5 seconds
on 7 channels.

Wrote Python script to parse Saleae output. 
Using Bit 7 (LSB) as ~RD

Using 3 pots, 2.5V, and 1 mic, 2.5V DC + 1-2V AC
Latching on rising edge of ~RD, see crosstalk on order of
+/- 4 bits (16) on adjacent wires, and signal of O(200) p-p when
when interpreting as 0-1023, so that means 10% noise.
Can't do much about it for now. That's a conservative estimate, btw.
Will need to re-measure when more are active mics, too.

Built all 4 pre-amps
Set up mic/speaker co-ax, using hot glue to attach to cans.
Tested speaker pair this way - volume matching simple, using ears,
but they definitely have different frequency responses at 400 Hz.
Oh well!

Confirmed pre-amps using scope
Hot-glue on on one mic, see if it looks the same on the scope
Hot-glue on the rest
Use one mic near ear, taped/hotglued and supported using 
	fuzzy-wire.
Label mic directions, meaning, + speaker meanings + switch meanings.

Ran adc_hardware_test and check for noise with scope on Vin...		
	no periodic fuzziness on Rd signal, which is great.
	
	sporadic loud speaker buzz/hiss at first, not sure of cause.
		possible grounding issue
			happens when moving headphones around
		BIG DEAL - but deal with it later.
		
	if i hum, i hear an increased hiss.
		this might be an artifact of the DACs not being actively driven in this test.
		confirm with next test, drive both ADC+DACs.
	
Confirmed pre-amps using scope
	done
Confirmed sampling (ignore cross talk for now) 
	done
	using Saleae + clicking fingers near each outer.
	
Noticing that system can be easily brought down
by a short on tall resistors/caps. Be aware of this -
check carefully when plugging in wiring.
				
	
To Do - Headphones: Wednesday Morning
-------------------------------------
Spend a while trying to isolate random BUZZ noise issue.
  Noticed that changing DAC divider gnd on RSPK away from
  the GND shared with the pre-amps/mics dramatically reduces 
  digital spiking (GND also shared with ADC). So ground
  loops matter! 
  
  Will drive DACs and see if humming still feedsback.
  Don't see it here. Try four mics. Nope.
  
  Also tried plugging Saleae in. Nothing.
   
  Tested for shorts to gnd and headphone casing when pressing on speakers,
  there are no connections to either from the speaker terminals,
  despite the fact that I forgot to hot-glue one of the speakers'
  extra +/- terminal pads.
  
  For now, can't reproduce the issue. Let's just ignore it till it comes back.

DAC-ADC matching test.
	Now, try 4000Hz off DACs, at 
	0-50 amplitude on DAC => same input scale on inner mics. 
	
	Whoops, my sine wave generator changes freq/amplitude at the same time.
	Ok, well, as it stands, 0-50 => 2kHz (40kHz/20 steps per cycle)
	This sounds loud as hell - blocks out everything else with cups on
	On the mics, shows up in one cup as 117-138 => 21 p-p. 
	But.. doubling volume isn't an option, it's already loud.
	
	So.. need to double gain on ADC! Shit. 
	We're already at a gain where LOUD outside noises
	can hit 0-5 V. Well, too bad. Let's see what happens.
	
	Ok, silliness. Changing ideal feedback gain from 200->400
	did nothing. If anything it reduced the gain.
	
	The reason being, the op-amps (MAX4466) have 600kHz GBW
	so at 2kHz, we're 300x in, or 50dB up from 1x, or about 
	500x gain. So we're pretty close to the limit of the device,
	and we're going to start seeing drops from ideal gains.
	
	In this case, at 200x gain, ignoring the 60Hz hum,
	which even if we tried to cancel we would'd hear anyways,
	we see ~100mV p-p 2kHz signal in both 200x and 400x gains.
	
	I think the solution here is really to increase
	the number of gain stages and reduce the per-stage gain.
	Unfortunately, I'm nearly out of those op-amps (3 left, and only 1 breakout board)
	
	Ok, so we have 0->50 p-p off the speaker
	leading to 0-20 p-p off the inner mics
	one of the speaker gains can  be increase, since it's a
	bit low, this is a good way to match the speakers.
	
	This means to cancel this waveform, the speakers
	will have to output 2x the volume => roughly speaking
	the filter coefficients will need to reach
	magnitude 2, and right now, they cap at 2^-1. 
	
		Also, scope clearly shows touching table introduces 60Hz
	hum into signal, because I am an antenna. Somehow touching board
	doesn't, since it grounds ME. But maybe if I touch the table
	I'm capacitively coupled to it, and I send this capacitively to
	the mics which are near my ear? Anyway.. really ought
	to filter that out digitally so we don't try to cancel it!
	It appears to have a larger amplitude than the actual audio signal
	at 2 kHz.. jeez. 

	Possible solutions:
		double or triple # of gain stages and reduce gain
		digitally double input waveform after subtracting 128
		allow filter coefficients to increase to 1-0.5-...
		
	Issues Noted
		60Hz hum will show up on ADC trace sometimes
		mismatched ADC-DAC might require larger filter coeffs
	
	Let's move on. I want to see how bad this sounds.
	Then we can come back to this.
	
	Try tuning DAC resistive divider till Saleae confirms match
	between two speakers, at least. 
	
	They're tuned, all right, but it's not pretty.
	The 0-50 p-p was the 60 Hz hum.
	If I reduce 60 Hz hum by not touching the table,
	the actual signal volume is 8 p-p signal, and 
	on the outer mics, possibly because I hotglued to the
	metal of the headphone can, so the can became a drum,
	i can clearly hear the sound, and it shows up as a
	4 p-p or 2 p-p sound.
	
	So we have 2x signal to noise - barely 6dB. 
	and we're feeding back -> very likely the system will
	screech after a while (in reality, just rail filter coefficients)
	
	I ought to use Saleae and a few pmods to output
	the filter coefficients in a string, so that 
	we can see the filter values as they evolve over time.
	
	Plenty more tests here, but let's try system wiring first.
	
	
Prepare yourself for the long haul.. you cannot give up on this;
demonstrating value means delivering - even if to yourself.

Tested human voice - me humming - system definitely 
can handle 100 p-p sounds, clear attenuation between outer
and inner mics, though honestly, not sure which is which..

Can serialize filters, samples, outputs, and read them on three streams
in parallel for each time step, using Saleae.

Also can use Discovery board to parallelize, learn about RTX and
make iteration a lot easier.
	
Ok, first pass: System VHDL wiring, just to see how bad life is.
This is like running a testbench in CS124. You don't expect to pass,
but it helps a lot.

	Three switches-  reset, oe, adaptation
	no LEDs for. No timed adaptation.
	Vin mapping is 0-1-2-3 => l0, li, ri, ro 
	spk mapping is known already.	

Run system sanity checks in HW - no software test at first.
	Check RD/... signals -> does plugging in ADC lines
	cause noise again?

Calibration, debugging during first run
	Saleae is your friend.

SW test if nothing works, but otherwise trust VHDL

Failed to adapt. 3/16/2016, 10 PM.
	- Lots of noise on ADC Databus PMOD connection.
	- Changed fsm_adc to latch databus (need to revert)
	- Nothing happened, noise still there. It's in power rails,
	that fuzziness.
	- Then, removed logic-level converter, and replaced with 1/2 dividers.
	Removed entire 3.3V rail from FPGA, actually.
	- Now, signals look good on ADC outputs.
	- However, now need to change signals to LVCMOS25 
	- Also need to remove Databus latch.
	- Also, need to re-Saleae to make sure
	 all is still well (unit test ADChardware.. sw..)
	- Then, can proceed. Need to understand what
	system thinks it's doing - that means Saleae + parsers.
	- Then can proceed.
	
	Definitely worth, in parallel, porting to an STM Discovery board.
	